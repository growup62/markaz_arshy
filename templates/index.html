{% extends 'layout.html' %}

{% block title %}User Dashboard{% endblock %}

{% block content %}
    <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800">Dashboard</h1>
    <p class="text-base sm:text-lg mb-6 text-gray-700 text-center">Selamat datang, {{ user.username }}!</p>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mb-6">
        <!-- Kolom Informasi License -->
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl hover:shadow-2xl transition duration-300">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">Informasi License</h2>
            <dl class="space-y-3 text-gray-700">
                <div>
                    <dt class="font-medium">Status License:</dt>
                    <dd><span class="{{ badge_class }} text-white px-2.5 py-1.5 rounded-full text-sm font-semibold">{{ license_status }}</span></dd>
                </div>
                <div>
                    <dt class="font-medium">License Anda:</dt>
                    <dd class="flex items-center mt-1">
                        <span id="api-key" class="truncate flex-grow bg-gray-50 p-2 rounded-md text-sm font-mono text-gray-800 w-full sm:w-auto break-all">{{ user.api_key | default('N/A', true) }}</span>
                        <button onclick="copyToClipboard('api-key', 'copy-api-key-success')" class="ml-2 bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition duration-200 text-sm font-semibold" aria-label="Copy License">
                            <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
                            Copy
                        </button>
                    </dd>
                    <p class="text-green-600 mt-2 hidden text-sm font-medium" id="copy-api-key-success">License berhasil disalin!</p>
                </div>
                <div>
                    <dt class="font-medium">Berlaku dari:</dt>
                    <dd>{{ user.start_date | default('N/A', true) }}</dd>
                </div>
                <div>
                    <dt class="font-medium">Berlaku hingga:</dt>
                    <dd>{{ user.end_date | default('N/A', true) }}</dd>
                </div>
            </dl>
        </div>

        <!-- Kolom Status Sinyal Terakhir -->
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl hover:shadow-2xl transition duration-300">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">Status Sinyal Terakhir <span class="text-sm text-gray-500">(Auto-refresh: 15 detik)</span></h2>
            <div id="latest-signal-container" class="text-gray-700">
                <!-- Konten sinyal akan dimuat oleh JavaScript -->
                <p class="text-gray-600">Memuat sinyal...</p>
            </div>
        </div>
    </div>

    <!-- ===== BAGIAN BARU: REAL-TIME LOG MONITOR ===== -->
    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl hover:shadow-2xl transition duration-300">
        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">Log Aktivitas Bot (Real-time)</h2>
        <div class="bg-gray-900 text-white font-mono text-xs rounded-lg shadow-inner p-4 h-80 overflow-y-auto" id="log-container">
            <p class="text-gray-400">Menunggu log dari bot...</p>
        </div>
    </div>
    <!-- ===== AKHIR BAGIAN BARU ===== -->


    <script>
        // Fungsi copy-paste yang sudah ada
        function copyToClipboard(elementId, successMessageId) {
            const element = document.getElementById(elementId);
            const text = element.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const successMsg = document.getElementById(successMessageId);
                if (successMsg) {
                    successMsg.classList.remove('hidden');
                    setTimeout(() => successMsg.classList.add('hidden'), 2000);
                } else {
                    alert('Berhasil disalin!');
                }
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Gagal menyalin. Silakan coba lagi atau salin manual.');
            });
        }

        // Fungsi fetch sinyal yang sudah ada
        function fetchLatestSignal() {
            const userApiKey = "{{ user.api_key }}";
            // Anda bisa menentukan simbol default atau mengambil dari input lain jika perlu
            const symbolToCheck = "XAUUSD"; 

            fetch(`/api/get_signal?key=${userApiKey}&symbol=${symbolToCheck}`)
            .then(response => {
                if (!response.ok) { return response.json().then(err => Promise.reject(err)); }
                return response.json();
            })
            .then(data => {
                const signalContainer = document.getElementById('latest-signal-container');
                if (!signalContainer) return;

                if (data.order_type && data.order_type !== 'WAIT') {
                    let signalColorClass = 'text-gray-600';
                    if (data.order_type.includes('BUY')) signalColorClass = 'text-green-600';
                    else if (data.order_type.includes('SELL')) signalColorClass = 'text-red-600';

                    signalContainer.innerHTML = `
                        <div class="space-y-2">
                            <p class="font-semibold">Sinyal Saat Ini: 
                                <span class="${signalColorClass} text-lg">
                                    ${data.order_type}
                                </span>
                            </p>
                            <p><strong>Diperbarui pada:</strong> ${data.timestamp || 'N/A'}</p>
                        </div>
                    `;
                } else {
                    signalContainer.innerHTML = `<p class="text-gray-600">Belum ada sinyal yang dihasilkan. Server sedang menganalisis...</p>`;
                }
            })
            .catch(error => {
                const signalContainer = document.getElementById('latest-signal-container');
                if(signalContainer) signalContainer.innerHTML = `<p class="text-red-500">Gagal memuat sinyal: ${error.error || 'Cek koneksi'}</p>`;
                console.error('Error fetching latest signal:', error);
            });
        }
        
        document.addEventListener('DOMContentLoaded', fetchLatestSignal);
        setInterval(fetchLatestSignal, 15000);
    </script>

    <!-- ===== SKRIP BARU: UNTUK REAL-TIME LOG ===== -->
    <!-- Impor library Socket.IO client -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <!-- Skrip untuk terhubung dan menampilkan log -->
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const socket = io();
            const logContainer = document.getElementById('log-container');
            let initialMessage = logContainer.querySelector('p');

            socket.on('new_log', function(data) {
                if (initialMessage) {
                    logContainer.innerHTML = '';
                    initialMessage = null;
                }

                const logMessage = document.createElement('p');
                const messageText = data.message || '';
                logMessage.textContent = messageText;
                
                if (messageText.includes('ERROR') || messageText.includes('CRITICAL')) {
                    logMessage.className = 'text-red-400';
                } else if (messageText.includes('WARNING')) {
                    logMessage.className = 'text-yellow-400';
                } else if (messageText.includes('âœ…') || messageText.includes('SUCCESS') || messageText.includes('berhasil')) {
                    logMessage.className = 'text-green-400';
                }

                logContainer.appendChild(logMessage);
                logContainer.scrollTop = logContainer.scrollHeight;
            });

            socket.on('connect', function() {
                console.log('Terhubung ke server Socket.IO!');
            });

            socket.on('disconnect', function() {
                console.log('Koneksi ke server Socket.IO terputus.');
            });
        });
    </script>
    <!-- ===== AKHIR SKRIP BARU ===== -->
{% endblock %}